# Настройка автоматической синхронизации телефонных номеров из Telnyx

## Как это работает

Система автоматически синхронизирует ваши телефонные номера из Telnyx двумя способами:

### 1. Автоматическая синхронизация
- **При загрузке страницы** - номера синхронизируются автоматически
- **Каждые 5 минут** - периодическая синхронизация (можно включить/выключить)
- **По событиям Telnyx** - через webhooks (требует настройки)

### 2. Ручная синхронизация
- Кнопка "Sync Now" для мгновенной синхронизации
- Вкладка "Manual Add" для добавления номеров вручную

## Настройка

### Шаг 1: Убедитесь, что у вас есть Telnyx API Key

В Supabase dashboard установите переменную окружения:
```bash
TELNYX_API_KEY=KEY0123456789ABCDEF...
```

### Шаг 2: Откройте страницу управления номерами

Перейдите на `/phone-management` в вашем приложении

### Шаг 3: Проверьте статус подключения

- ✅ **Connected to Telnyx** - всё работает
- ⚠️ **Telnyx Not Connected** - проверьте API ключ

### Шаг 4: Настройте Webhook (опционально)

Для получения уведомлений о новых номерах в реальном времени:

1. Деплой webhook функции:
```bash
supabase functions deploy telnyx-webhook-handler
```

2. Получите URL вашего webhook:
```
https://mqppvcrlvsgrsqelglod.supabase.co/functions/v1/telnyx-webhook-handler
```

3. В Telnyx Mission Control Portal:
   - Перейдите в **Account Settings** → **Webhooks**
   - Добавьте новый webhook URL
   - Выберите события:
     - `phone_number.created`
     - `phone_number.updated`
     - `phone_number.deleted`
     - `number_order.phone_numbers_created`

## Функции компонента TelnyxPhoneSync

### Автоматические функции:
1. **Проверка подключения** - при загрузке проверяет доступность Telnyx API
2. **Начальная синхронизация** - загружает все номера из Telnyx
3. **Периодическая синхронизация** - обновляет список каждые 5 минут
4. **Отображение статуса** - показывает время последней синхронизации

### Информация о номерах:
- Номер телефона
- Статус (available/active)
- Код региона
- Город и штат (если доступно)
- Статус подключения
- Доступность для назначения

## API вызовы

### Получение номеров из Telnyx
```javascript
// Вызывается автоматически при загрузке
const { data } = await supabase.functions.invoke('telnyx-phone-numbers', {
  body: { action: 'list_available_from_telnyx' }
});
```

### Проверка подключения
```javascript
const { data } = await supabase.functions.invoke('telnyx-phone-numbers', {
  body: { action: 'test_telnyx_connection' }
});
```

## Troubleshooting

### Номера не синхронизируются
1. Проверьте Telnyx API key в Supabase
2. Убедитесь, что edge функция развернута
3. Проверьте консоль браузера на ошибки

### Webhook не работает
1. Проверьте, что функция `telnyx-webhook-handler` развернута
2. Убедитесь, что URL правильный в Telnyx
3. Проверьте логи функции в Supabase

### Номера не отображаются
1. Нажмите "Sync Now" для ручной синхронизации
2. Проверьте таблицу `telnyx_phone_numbers` в Supabase
3. Убедитесь, что у вас есть номера в Telnyx аккаунте

## Дополнительные возможности

- Фильтрация по статусу
- Поиск по номеру или региону
- Массовое добавление номеров
- Экспорт списка номеров
- История изменений

Эти функции можно добавить по запросу.

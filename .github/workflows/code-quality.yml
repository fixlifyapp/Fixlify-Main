name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: ESLint & TypeScript Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --max-warnings 100

      - name: TypeScript type check
        run: npx tsc --noEmit

  duplicates:
    name: Code Duplication Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for code duplicates
        run: |
          npm run code:duplicates || true
        continue-on-error: true

      - name: Generate duplication report
        run: |
          mkdir -p reports
          npm run code:report || true
        continue-on-error: true

      - name: Upload duplication report
        uses: actions/upload-artifact@v4
        with:
          name: duplication-report
          path: reports/
          retention-days: 30
        if: always()

  health-report:
    name: Code Health Report
    runs-on: ubuntu-latest
    needs: [lint, duplicates]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate health report
        id: health
        run: |
          echo "## Code Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count files
          TS_FILES=$(find src -name "*.ts" -o -name "*.tsx" | wc -l)
          echo "- **TypeScript Files**: $TS_FILES" >> $GITHUB_STEP_SUMMARY

          # Count lines
          TOTAL_LINES=$(find src -name "*.ts" -o -name "*.tsx" | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
          echo "- **Total Lines**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY

          # Count console.logs (code smell)
          CONSOLE_LOGS=$(grep -r "console\\.log" src --include="*.ts" --include="*.tsx" | wc -l)
          echo "- **console.log statements**: $CONSOLE_LOGS" >> $GITHUB_STEP_SUMMARY

          # Count TODO/FIXME
          TODOS=$(grep -rE "(TODO|FIXME)" src --include="*.ts" --include="*.tsx" | wc -l)
          echo "- **TODO/FIXME comments**: $TODOS" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY

          if [ "$CONSOLE_LOGS" -gt 100 ]; then
            echo "- Consider removing excessive console.log statements ($CONSOLE_LOGS found)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TODOS" -gt 50 ]; then
            echo "- High number of TODO/FIXME comments ($TODOS found) - consider creating issues" >> $GITHUB_STEP_SUMMARY
          fi
